<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Cartellino Lavorazione - Modello Completo</title>
<meta name="theme-color" content="#1e1e1e">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@700&display=swap');

  /* --- STILI VIDEO (DARK MODE) --- */
  body {
    margin: 0; padding: 0;
    font-family: 'Roboto', sans-serif;
    background-color: #121212; color: #e0e0e0;
    display: flex; flex-direction: column; align-items: center;
    padding-top: 80px; padding-bottom: 120px;
    overflow-x: hidden;
  }

  /* TOP BAR */
  .top-bar, .bottom-bar {
    position: fixed; left: 0; width: 100%;
    background: #1e1e1e; border-color: #333; border-style: solid;
    display: flex; align-items: center; justify-content: center; z-index: 1000;
  }
  .top-bar { top: 0; border-bottom-width: 1px; flex-direction: column; padding: 10px 0; height: auto;}
  .bottom-bar { bottom: 0; border-top-width: 1px; height: 70px; gap: 10px; padding: 0 10px; box-sizing: border-box;}

  /* SELETTORE MACCHINA */
  .machine-selector { display: flex; gap: 20px; margin-top: 8px; background: #252525; padding: 5px 15px; border-radius: 20px; border: 1px solid #444;}
  .mac-opt { font-size: 13px; color: #aaa; cursor: pointer; display: flex; align-items: center; gap: 5px; }
  .mac-opt input { width: auto; margin: 0; accent-color: #4caf50; }
  .mac-opt span { font-weight: bold; }
  .mac-opt input:checked + span { color: #4caf50; }

  /* CONTENITORE */
  .sheet-container {
    width: 94%; max-width: 1200px;
    background-color: #1e1e1e; padding: 15px;
    border: 1px solid #333; border-radius: 8px; margin-bottom: 20px;
    box-sizing: border-box;
  }

  h1 { font-size: 18px; color: #fff; margin: 0; text-align: center; text-transform: uppercase; }
  h2 { font-size: 14px; color: #4caf50; border-bottom: 1px solid #4caf50; margin-top: 20px; margin-bottom: 10px; padding-bottom: 5px; text-transform: uppercase; }

  /* INPUT FIELDS */
  input, select, textarea {
    background: transparent; border: none; border-bottom: 1px solid #555;
    color: #fff; width: 100%; font-family: inherit; font-size: 14px; padding: 5px 0; box-sizing: border-box;
  }
  input:focus, textarea:focus { border-bottom: 2px solid #4caf50; outline: none; background: #252525; }
  label { font-size: 10px; color: #aaa; font-weight: bold; display: block; margin-top: 8px; text-transform: uppercase;}

  /* GRID SYSTEM RESPONSIVE */
  .header-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
      gap: 15px; margin-bottom: 20px; 
  }
  
  /* Sezioni specifiche header */
  .header-section { border: 1px solid #333; padding: 10px; border-radius: 6px; background: #222; }

  /* TABELLA DATI */
  .cycle-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; table-layout: fixed; }
  .cycle-table th { background: #2c2c2c; color: #fff; padding: 8px; font-size: 10px; text-transform: uppercase; position: sticky; top: 0; z-index: 10;}
  .cycle-table td { background: #1e1e1e; border-bottom: 1px solid #333; padding: 8px; vertical-align: top; }

  /* Width Colonne Desktop */
  .col-n { width: 35px; text-align: center; color: #777; font-weight: bold; }
  .col-sketch { display: none; } /* Solo PDF */
  .col-desc { width: auto; }
  .col-tools { width: 130px; }
  .col-param { width: 70px; text-align: center; }
  .col-time { width: 60px; text-align: center; }
  .col-del { width: 40px; text-align: center; }

  .inp-param { text-align: center; font-family: 'Courier Prime', monospace; color: #ffd54f; font-weight: bold; font-size: 15px;}
  .inp-time { text-align: center; font-weight: bold; color: #fff; background: #252525; border-radius: 4px; padding: 8px; }

  /* BOTTONI */
  button {
    padding: 12px; border: none; border-radius: 4px; font-weight: bold; 
    cursor: pointer; color: #fff; text-transform: uppercase; font-size: 13px; flex: 1;
  }
  .btn-print { background: #fff; color: #000; }
  .btn-add { background: #2979ff; }
  .btn-reset { background: #d32f2f; }
  .btn-del { background: transparent; color: #d32f2f; border: 1px solid #d32f2f; width: 30px; height: 30px; padding: 0; border-radius: 4px;}

  /* --- MOBILE OPTIMIZATION --- */
  @media screen and (max-width: 900px) {
    .sheet-container { padding: 10px; width: 96%; }
    
    /* Intestazione su una colonna */
    .header-grid { grid-template-columns: 1fr; gap: 10px; }
    
    /* Trasformazione Tabella in Card */
    .cycle-table, thead, tbody, th, td, tr { display: block; }
    thead { display: none; }
    
    tr.cycle-row {
      background: #1e1e1e; border: 1px solid #333; margin-bottom: 25px; 
      padding: 15px; border-radius: 8px; position: relative;
      padding-top: 45px;
      /* Griglia interna card */
      display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    }

    .col-n { 
        position: absolute; top: 10px; left: 10px; 
        background: #333; color: #fff; width: 30px; height: 30px; 
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        border: 1px solid #555;
    }
    .col-del { position: absolute; top: 10px; right: 10px; width: auto; }

    td { border: none; padding: 0; }
    
    .col-desc, .col-tools { grid-column: 1 / -1; }
    .col-desc textarea { background: #252525; border-radius: 4px; border: 1px solid #444; padding: 10px; min-height: 60px; }
    
    /* Parametri */
    .col-param { grid-column: span 1; background: #252525; padding: 5px !important; border-radius: 4px; text-align: center; display: flex; flex-direction: column-reverse; }
    .col-param label { margin-bottom: 2px; text-align: center; color: #888; font-size: 9px; height: 20px; line-height: 1; display:flex; align-items:center; justify-content:center;}
    .inp-param { width: 100%; border-bottom: none; font-size: 16px; padding: 0;}

    /* Tempo */
    .col-time { grid-column: 1 / -1; margin-top: 5px; border-top: 1px solid #333; padding-top: 10px !important; display: flex; align-items: center; justify-content: space-between;}
    .col-time input { width: 80px; font-size: 20px; text-align:right;}
  }
</style>

<script>
  // CONFIGURAZIONE MACCHINE (Con unità corrette per il PDF)
  const macConfig = {
      lathe: { vt: "Vt\n[m/min]", n: "n\n[g/min]", f: "a\n[mm/g]", p: "p\n[mm]" },
      mill:  { vt: "Vc\n[m/min]", n: "n\n[g/min]", f: "Vf\n[mm/min]", p: "ap\n[mm]" },
      grind: { vt: "Vs\n[m/s]",   n: "Vw\n[m/min]", f: "a\n[mm/c]",  p: "p\n[mm]" }
  };

  let currentMac = 'lathe';

  function setMachine(type) {
      currentMac = type;
      const cfg = macConfig[type];
      
      // Update label a video (rimuovo \n per display)
      const clean = (str) => str.replace('\n', ' ');
      document.getElementById('h-vt').innerText = clean(cfg.vt);
      document.getElementById('h-n').innerText = clean(cfg.n);
      document.getElementById('h-f').innerText = clean(cfg.f);
      document.getElementById('h-p').innerText = clean(cfg.p);

      document.querySelectorAll('.cycle-row').forEach(row => {
          row.querySelector('.lbl-vt').innerText = clean(cfg.vt);
          row.querySelector('.lbl-n').innerText = clean(cfg.n);
          row.querySelector('.lbl-f').innerText = clean(cfg.f);
          row.querySelector('.lbl-p').innerText = clean(cfg.p);
      });
  }

  function addRow() {
    const tbody = document.getElementById('cycleBody');
    const n = (tbody.querySelectorAll('tr').length + 1) * 10;
    const cfg = macConfig[currentMac];
    const clean = (str) => str.replace('\n', ' ');

    const tr = document.createElement('tr');
    tr.className = 'cycle-row';
    tr.innerHTML = `
      <td class="col-n">${n}</td>
      <td class="col-desc">
        <label>Operazione</label>
        <textarea rows="2" class="inp-op" placeholder="Descrizione..."></textarea>
      </td>
      <td class="col-tools">
        <label>Utensili / Note</label>
        <textarea rows="2" class="inp-tool" placeholder="Utensile..."></textarea>
      </td>
      
      <td class="col-param">
        <label class="lbl-vt">${clean(cfg.vt)}</label>
        <input type="number" class="inp-vt inp-param" placeholder="-">
      </td>
      <td class="col-param">
        <label class="lbl-n">${clean(cfg.n)}</label>
        <input type="number" class="inp-n inp-param" placeholder="-">
      </td>
      <td class="col-param">
        <label class="lbl-f">${clean(cfg.f)}</label>
        <input type="number" class="inp-f inp-param" placeholder="-">
      </td>
      <td class="col-param">
        <label class="lbl-p">${clean(cfg.p)}</label>
        <input type="number" class="inp-p inp-param" placeholder="-">
      </td>

      <td class="col-time">
        <label>Tempo (min)</label>
        <input type="number" class="inp-time" placeholder="0">
      </td>
      
      <td class="col-del">
        <button class="btn-del" onclick="this.closest('tr').remove()">✕</button>
      </td>
    `;
    tbody.appendChild(tr);
    if(window.innerWidth < 900) setTimeout(() => { tr.scrollIntoView({behavior: "smooth", block: "center"}); }, 100);
  }

  // --- GENERAZIONE PDF (LAYOUT ESATTO) ---
  async function generatePDF() {
    if(!window.jspdf) { alert("Attendi caricamento librerie..."); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4'); // A4 Verticale
    
    // Recupero Dati
    const studentInfo = {
        name: document.getElementById('stdName').value,
        class: document.getElementById('stdClass').value,
        as: document.getElementById('stdAS').value,
        date: document.getElementById('stdDate').value,
        grade: document.getElementById('stdGrade').value
    };
    
    const matInfo = {
        name: document.getElementById('matName').value,
        raw: document.getElementById('matRaw').value,
        qty: document.getElementById('matQty').value,
        rm: document.getElementById('matRm').value,
        mass: document.getElementById('matMass').value,
        heat: document.getElementById('matHeat').value,
        hbw: document.getElementById('matHBW').value
    };

    // --- DISEGNO GRIGLIA INTESTAZIONE (Manuale per precisione) ---
    doc.setLineWidth(0.3);
    doc.setFont("helvetica", "bold");
    doc.setFontSize(10);
    
    // 1. Box Studente (Alto)
    // x, y, w, h
    const topY = 10;
    const colW = 190 / 5; // 5 colonne
    
    // Header riga 1
    doc.rect(10, topY, 190, 8); // Box esterno header
    // Linee verticali
    doc.line(10 + colW, topY, 10 + colW, topY + 16); 
    doc.line(10 + colW*2, topY, 10 + colW*2, topY + 16);
    doc.line(10 + colW*3, topY, 10 + colW*3, topY + 16);
    doc.line(10 + colW*4, topY, 10 + colW*4, topY + 16);
    
    // Etichette
    doc.setFontSize(8);
    doc.text("STUDENTE", 11, topY + 3);
    doc.text("CLASSE", 11 + colW, topY + 3);
    doc.text("A.S.", 11 + colW*2, topY + 3);
    doc.text("DATA CONSEGNA", 11 + colW*3, topY + 3);
    doc.text("VOTO", 11 + colW*4, topY + 3);
    
    // Valori Studente
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.rect(10, topY+8, 190, 8); // Riga valori
    doc.text(studentInfo.name, 11, topY + 14);
    doc.text(studentInfo.class, 11 + colW, topY + 14);
    doc.text(studentInfo.as, 11 + colW*2, topY + 14);
    doc.text(studentInfo.date, 11 + colW*3, topY + 14);
    doc.text(studentInfo.grade, 11 + colW*4, topY + 14);

    // 2. Box Materiale (Sinistra)
    const matY = topY + 20;
    doc.setFont("helvetica", "bold");
    doc.setFontSize(9);
    
    // Riga 1: Materiale e Ricavato
    doc.text(`MATERIALE: ${matInfo.name}`, 10, matY);
    doc.text(`RICAVATO DA: ${matInfo.raw}`, 100, matY);
    
    // Box Dati Materiale
    const boxY = matY + 3;
    const boxH = 25;
    doc.rect(10, boxY, 130, boxH);
    
    doc.setFontSize(8);
    doc.setFont("helvetica", "normal");
    let lineY = boxY + 5;
    doc.text("CARATTERISTICHE DEL MATERIALE", 12, lineY); lineY += 5;
    doc.text(`QUANTITA': ${matInfo.qty}`, 12, lineY); lineY += 5;
    doc.text(`Rm [N/mm2]: ${matInfo.rm}`, 12, lineY); lineY += 5;
    doc.text(`MASSA [kg]: ${matInfo.mass}`, 12, lineY); lineY += 5;
    
    // Colonna destra nel box materiale
    lineY = boxY + 15;
    doc.text(`TRATTAMENTI TERMICI: ${matInfo.heat}`, 70, lineY); lineY += 5;
    doc.text(`Durezza HBW: ${matInfo.hbw}`, 70, lineY);

    // 3. Box Destra (Titolo Ciclo)
    doc.rect(145, boxY, 55, boxH);
    doc.setFont("helvetica", "bold");
    doc.setFontSize(10);
    doc.text("CICLO DI", 172.5, boxY + 8, {align: "center"});
    doc.text("LAVORAZIONE", 172.5, boxY + 13, {align: "center"});
    
    doc.setFontSize(8);
    doc.text("FOGLIO N°", 150, boxY + 22);

    // --- TABELLA FASI ---
    const rows = [];
    document.querySelectorAll('.cycle-row').forEach(row => {
        rows.push([
            row.querySelector('.col-n').innerText,
            "", // Schizzo vuoto
            row.querySelector('.inp-op').value,
            row.querySelector('.inp-tool').value,
            row.querySelector('.inp-vt').value,
            row.querySelector('.inp-n').value,
            row.querySelector('.inp-f').value,
            row.querySelector('.inp-p').value,
            row.querySelector('.inp-time').value
        ]);
    });

    const cfg = macConfig[currentMac];
    const header = [['N°', 'SCHIZZO', 'OPERAZIONE', 'MACCHINE,\nUTENSILI,\nCALIBRI', cfg.vt, cfg.n, cfg.f, cfg.p, 'TEMPI\n[min]']];

    doc.autoTable({
        startY: boxY + boxH + 5,
        head: header,
        body: rows,
        theme: 'grid',
        
        columnStyles: {
            0: { cellWidth: 8, halign: 'center', fontStyle: 'bold' }, // N
            1: { cellWidth: 50, minCellHeight: 35 }, // SCHIZZO (Molto largo e alto)
            2: { cellWidth: 'auto' }, // OPERAZIONE (Si adatta)
            3: { cellWidth: 25 }, // UTENSILI
            4: { cellWidth: 14, halign: 'center' }, 
            5: { cellWidth: 14, halign: 'center' }, 
            6: { cellWidth: 14, halign: 'center' }, 
            7: { cellWidth: 14, halign: 'center' }, 
            8: { cellWidth: 12, halign: 'center' } 
        },
        styles: { 
            fontSize: 8, textColor: 0, lineColor: 0, lineWidth: 0.1, valign: 'middle', overflow: 'linebreak'
        },
        headStyles: { 
            fillColor: 255, textColor: 0, fontStyle: 'bold', lineWidth: 0.3, halign: 'center', valign: 'middle'
        },
        margin: { top: 10, left: 10, right: 10 }
    });

    doc.save("Cartellino_Lavorazione.pdf");
  }

  function resetSheet() { if(confirm("Resettare tutto?")) location.reload(); }
</script>
</head>
<body onload="addRow(); addRow();">

<div class="top-bar">
    <span style="color:#fff; font-weight:bold; font-size:16px;">PACINILAB CARTELLINO</span>
    <div class="machine-selector">
        <label class="mac-opt"><input type="radio" name="mac" checked onclick="setMachine('lathe')"> <span>TORNIO</span></label>
        <label class="mac-opt"><input type="radio" name="mac" onclick="setMachine('mill')"> <span>FRESA</span></label>
        <label class="mac-opt"><input type="radio" name="mac" onclick="setMachine('grind')"> <span>RETTIFICA</span></label>
    </div>
</div>

<div class="sheet-container">
    <div style="text-align:center; margin-bottom:20px;">
        <h1>CARTELLINO DI LAVORAZIONE</h1>
        <p class="subtitle">Layout identico al cartaceo (A4 Verticale)</p>
    </div>
    
    <h2>Dati Studente</h2>
    <div class="header-grid">
        <div class="header-section">
             <label>Allievo</label><input type="text" id="stdName">
        </div>
        <div class="header-section">
             <label>Classe</label><input type="text" id="stdClass">
        </div>
        <div class="header-section">
             <label>A.S.</label><input type="text" id="stdAS" value="2025/26">
        </div>
        <div class="header-section">
             <label>Data Consegna</label><input type="date" id="stdDate">
        </div>
        <div class="header-section">
             <label>Voto</label><input type="text" id="stdGrade">
        </div>
    </div>

    <h2>Dati Materiale</h2>
    <div class="header-grid">
        <div class="header-section">
             <label>Materiale</label><input type="text" id="matName">
        </div>
        <div class="header-section">
             <label>Ricavato da</label><input type="text" id="matRaw">
        </div>
        <div class="header-section">
             <label>Quantità</label><input type="number" id="matQty" value="1">
        </div>
        <div class="header-section">
             <label>Rm [N/mm²]</label><input type="text" id="matRm">
        </div>
        <div class="header-section">
             <label>Massa [kg]</label><input type="text" id="matMass">
        </div>
        <div class="header-section">
             <label>Trattamenti Termici</label><input type="text" id="matHeat">
        </div>
        <div class="header-section">
             <label>Durezza HBW</label><input type="text" id="matHBW">
        </div>
    </div>

    <h2>Ciclo di Lavorazione</h2>
    <table class="cycle-table">
        <thead>
            <tr>
                <th class="col-n">N°</th>
                <th class="col-desc">OPERAZIONE</th>
                <th class="col-tools">MACCHINE/UTENSILI</th>
                <th class="col-param" id="h-vt">Vt</th>
                <th class="col-param" id="h-n">n</th>
                <th class="col-param" id="h-f">f</th>
                <th class="col-param" id="h-p">p</th>
                <th class="col-time">Tc</th>
                <th class="col-del"></th>
            </tr>
        </thead>
        <tbody id="cycleBody">
            </tbody>
    </table>
    
    <button onclick="addRow()" class="btn-add" style="width:100%; margin-top:15px;">+ AGGIUNGI FASE</button>
</div>

<div class="bottom-bar">
    <button class="btn-print" onclick="generatePDF()">SCARICA PDF </button>
    <button class="btn-reset" onclick="resetSheet()">RESET</button>
</div>

</body>
</html>
